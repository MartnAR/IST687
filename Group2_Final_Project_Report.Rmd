---
title: "Final Project Report"
subtitle: "IST687 - Group B2"
authors: "Amani Alawneh, Martin Alonso, Michael Cerutti, Susannah Cleland"
date: "9/26/2018"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
require(dplyr)
require(ggplot2)
require(formatR)
require(magrittr)
```

## Table of Contents

### INTRODUCTION
1. Project Background and Description
2. Project Scope and Context of this Analysis

### BUSINESS QUESTIONS
3. What are the Business Questions?

### DATA ACQUISITION, CLEANING, TRANSFORMATION, MUNGING
4.	Describe your data acquisition process
5.	What data did you select, all, subset, why
6.	What was your initial quality assessment
7.	What fields/variables did you finally decide on, why
8.	Provide a data dictionary
9.	Provide data descriptive statistics, rows, str
10. Did you have to do any cleansing, describe
11. Interesting findings

### DESCRIPTIVE STATISTICS
12. Provide demographic statistics – Location
13. Any early observations, nuggets of interest, interpretation, interesting findings
14. Graphs, charts, tables, visuals, text

### USE OF MODELING TECHNIQUES
15. Linear modeling
16. Support vector
17. Provide key statistics of interest and interpretation for each model

### OVERALL INTERPRETATION OF RESULTS/ACTIONABLE INSIGHTS
### REFERENCES
### APPENDIX – RStudio CODE

# FINAL PROJECT REPORT
## IST687 - GROUP B2
 
### INTRODUCTION
1. Project Background and Description  
This project is an exercise in taking a dataset from the 2017-2018 English Premier League season and tries to gauge what factors are able to predict which team is likelier to win; what factors are likely to separate winning teams from losing teams, and what can teams from the bottom of the chart learn from teams at the top.  
  
2. Project Scope and Context of this Analysis  
The scope of this project encompasses data gathered from the 2017-2018 English Premier League season, with goals scored, goals allowed, shots taken, shots allowed, win record, and other soccer metrics.
The data shows whether a team won, lost, or drew a game, how many shots did they take and allow, how many fouls they commited, how many goals they scored (both at half-time and end of regular time), and whether they received any yellow or red cards. 
Obviously, we expect that teams that score more goals tend to win more but, by looking at actual goal differential, we might find that this is not the case. We also want to see whether there are other factors that are pushing a teams' likelihood to win - such as shots taken, shots on goal taken, and corner kicks - as against to allowing an opposing team more chances to score.  
  
  
### BUSINESS QUESTIONS  
3. What are the Business Questions?  
   
  
  
### DATA ACQUISITION, CLEANSING, TRANSFORMATION, AND MUNGING
4.	Describe your data acquisition process.  
The data was acquired from `www.football-data.co.uk`, a website that provides free data on soccer coverage from around the world. For this project, we downloaded the csv file for the English Premier League 2017-2018 season. 
We grabbed the csv url and loaded it into RStudio using the following command:  

```{r tidy=TRUE}
url <- "http://www.football-data.co.uk/mmz4281/1718/E0.csv"
prem <- prem <- read.csv(url, stringsAsFactors = FALSE)
head(prem)
```
  
  
5.	What data did you select, all, subset, why?  
We decided to focus on just a single season of data, selecting data for both the home and away team regarding whether the home team one, lost, or drew, how many goals each team scored both at half-time and end of regulation, how many shots each team took both in general and on goal, corner kicks, fouls committed, yellow and red cards received, and other data such as the date, and referee. 
We also had different betting odds for all teams and for each match but we decided to drop these columns as they weren't part of the scope of the project. 

6.	What was your initial quality assessment?  
Our first quality assessment was to check that there were no missing values within the dataset.  
After that, we made sure that the data types were correct, i.e. strings weren't stored as factors, numbers were numeric, and dates were stored as dates.  
We also made sure that there were no `NULL` values or `NA's`, which fortunately there weren't.  
Finally, after the assessment was made, we decided to transform the dataset in order to have one row per team per date, renaming the columns, dropping the betting line columns, and adding a flag to signal whether the team in question was the home or away team.  

```{r tidy = TRUE}

#Select Home Team and Home team data. 
premHomeTeams <- prem %>% 
  dplyr::mutate(HomeAway = 'Home') %>% 
  dplyr::select(Div, Date, Team1 = HomeTeam, Team2 = AwayTeam, HomeAway, GS = FTHG, GA = FTAG, FTR, HTGS = HTHG, HTGA = HTAG, HTR, Referee, ShotsTaken = HS, ShotsAllowed = AS, ShotsOnTarget = HST, OppShotsOnTarget = AST, FoulsCommitted = HF, FoulsReceived = AF, CornerKicks = HC, OppCornerKicks = AC, YellowCards = HY, OppYellowCards = AY, RedCards = HR, OppRedCards = AR)

#Select Away Team and Away team data.
premAwayTeams <- prem %>% 
  dplyr::mutate(HomeAway = 'Away') %>% 
  dplyr::select(Div, Date, Team1 = AwayTeam, Team2 = HomeTeam, HomeAway, GS = FTAG, GA = FTHG, FTR, HTGS = HTAG, HTGA = HTHG, HTR, Referee, ShotsTaken = AS, ShotsAllowed = HS, ShotsOnTarget = AST, OppShotsOnTarget = HST, FoulsCommitted = AF, FoulsReceived = HF, CornerKicks = AC, OppCornerKicks = HC, YellowCards = AY, OppYellowCards = HY, RedCards = AR, OppRedCards = HR)

#Bind datasets into a new dataset. 
premTransformed <- premHomeTeams %>% bind_rows(premAwayTeams)
head(premTransformed)

```


7.	What fields/variables did you finally decide on, why  
The original dataset had 65 columns and 380 rows. The variables included regarded the league, date, teams playing, referee, match results and goals at half-time and at the end of regulation, statistics for the match, and betting odds for different sites. 
We transformed this data so as to end with 24 columns and 780 rows, setting on the following columns:  
* Match Information: `Div, Date, Team1, Team2, HomeAway, Referee`  
* Match Results: `GS, GA, FTR, HTGS, HTGA, HTR`  
* Match Statistics: `ShotsTaken, ShotsAllowed, ShotsOnTarget, OppShotsOnTarget, FoulsCommitted, FoulsReceived, CornerKicks, OppCornerKicks, YellowCards, OppYellowCards, RedCards, OppRedCards`  

```{r tidy=TRUE}
colnames(premTransformed)
```


8.	Provide a data dictionary  
```{r table2, echo=FALSE, message=FALSE, warning=FALSE, results='asis', tidy=TRUE}
tabl <- "
|Index | Column Name       |New Names                |Definition                            |
|:----:|:-----------------:|:------------------------|:-------------------------------------|
|  1   |  Div              | Division                | Football league division.            |
|  2   |  Date             | Match Day               | Day match was played.                |
|  3   |  Team1            | Team                    | First team of the match.             |
|  4   |  Team2            | Opponent                | Opposing team of the match.          |
|  5   |  HomeAway         | Home-Away Flag          | Team1 Home-Away identifier.          |
|  6   |  GS               | Goals Scored            | Goals scored by Team1.               |
|  7   |  GA               | Goals Allowed           | Goals allowed by Team1.              |
|  8   |  FTR              | Full Time Result        | Result at the end of regulation.     |
|  9   |  HTGS             | Half-time Goals Scored  | Goals scored at half-time by Team1.  |
| 10   |  HTGA             | Half-time Goals Allowed | Goals allowed at half-time by Team1. |
| 11   |  HTR              | Half-time Result        | Result at half-time.                 |
| 12   |  Referee          | Game Referee            | Referee for the match.               |
| 13   |  ShotsTaken       | Shots taken             | Shots taken by Team 1.               |
| 14   |  ShotsAllowed     | Shots allowed           | Shots allowed by Team 1.             |
| 15   |  ShotsOnTarget    | Shots on target         | Shots on goal taken by Team 1.       |
| 16   |  OppShotsOnTarget | Shots on target allowed | Shots on goal allowed by Team 1.     |
| 17   |  FoulsCommitted   | Fouls committed         | Fouls committed by Team 1.           |
| 18   |  FoulsReceived    | Fouls received          | Fouls committed by Opposing Team.    |
| 19   |  CornerKicks      | Corner kicks            | Corner kicks taken by Team 1.        |
| 20   |  OppCornerKicks   | Opponent corner kicks   | Corner kicks taken by Opposing Team. |
| 21   |  YellowCards      | Yellow cards            | Yellow cards given to Team 1.        |
| 22   |  OppYellowCards   | Opponent yellow cards   | Yellow cards given to Opposing Team. |
| 23   |  RedCards         | Red cards               | Red cards given to Team 1.           |
| 24   |  OppRedCards      | Opponent red cards      | Red cards given to Opposing Team.    |
"
cat(tabl)
```
  
  
9.	Provide data descriptive statistics, rows, str  
The complete dataset has 24 variables and 780 observations - two per match. The dataset does not have any NA's, meaning that there will be no additional data dropped.  
The following shows the dimensions and structure of the dataset.  

```{r tidy = TRUE}
dim(premTransformed)
str(premTransformed)
```


10. Did you have to do any cleansing, describe  
No, the dataset was already cleaned when we downloaded it.  
However, we did need to transform it as the data wasn't in the format we desired. We transformed it so that we our analysis and data modeling would be better adjusted and easier for the later stages of the project.  

11. Interesting findings  




### DESCRIPTIVE STATISTICS
12. Provide demographic statistics – Location  


13. Any early observations, nuggets of interest, interpretation, interesting findings  


14. Graphs, charts, tables, visuals, text  




### USE OF MODELING TECHNIQUES
15. Linear modeling  


16. Support vector  


17. Provide key statistics of interest and interpretation for each model  




### APPENDIX - RStudio Code
```{r eval=FALSE, tidy = TRUE}
#Load the required packages
require(dplyr)
require(ggplot2)
require(reshape2)
require(readxl)
require(ggplot2)
require(moments)
require(sqldf)
require(magrittr)
require(eeptools)

#Load the dataset into R 
prem1516 <- read.csv("http://www.football-data.co.uk/mmz4281/1516/E0.csv")
prem1617 <- read.csv("http://www.football-data.co.uk/mmz4281/1617/E0.csv")
prem1718 <- read.csv("http://www.football-data.co.uk/mmz4281/1718/E0.csv")

prem <- prem1516 %>% bind_rows(prem1617) %>% bind_rows(prem1718)

#Data transformation
#Select Home Team and Home team data. 
premHomeTeams <- prem %>% 
  mutate(HomeAway = 'Home') %>% 
  select(Div, Date, Team1 = HomeTeam, Team2 = AwayTeam, HomeAway, GS = FTHG, GA = FTAG, FTR, HTGS = HTHG, HTGA = HTAG, HTR, Referee, ShotsTaken = HS, ShotsAllowed = AS, ShotsOnTarget = HST, OppShotsOnTarget = AST, FoulsCommitted = HF, FoulsReceived = AF, CornerKicks = HC, OppCornerKicks = AC, YellowCards = HY, OppYellowCards = AY, RedCards = HR, OppRedCards = AR)

#Select Away Team and Away team data.
premAwayTeams <- prem %>% 
  mutate(HomeAway = 'Away') %>% 
  select(Div, Date, Team1 = AwayTeam, Team2 = HomeTeam, HomeAway, GS = FTAG, GA = FTHG, FTR, HTGS = HTAG, HTGA = HTHG, HTR, Referee, ShotsTaken = AS, ShotsAllowed = HS, ShotsOnTarget = AST, OppShotsOnTarget = HST, FoulsCommitted = AF, FoulsReceived = HF, CornerKicks = AC, OppCornerKicks = HC, YellowCards = AY, OppYellowCards = HY, RedCards = AR, OppRedCards = HR)

#Bind datasets into a new dataset. 
premTransformed <- premHomeTeams %>% bind_rows(premAwayTeams)

#Removing spaces from the character columns. 
premTransformed$Team1 <- gsub(" ", "", premTransformed$Team1)
premTransformed$Team2 <- gsub(" ", "", premTransformed$Team2)
premTransformed$HomeAway <- gsub(" ", "", premTransformed$HomeAway)

#Check the structure of the data, head, and see that there are no NAs.
str(premTransformed)
head(premTransformed)
summary(premTransformed)

#Column names need to be changed to better understand the data. 
colnames(premTransformed)

#Descriptive statistics. 

#The function performanceGoalsHomeAway computes totals and average of goals scored for and against Home and Away teams
#GF: Goal For, GA: Goal Against,	AVG
performanceGoalsHomeAway <- function(x) {
  df <- x
  MeanShotsTaken <- mean(df$ShotsTaken)
  MeanShotsOnTarget <- mean(df$ShotsOnTarget)
  MeanCornerKicks <- mean(df$CornerKicks)
  MeanFTGoals <- mean(df$GS)
  MeanHTGoals <- mean(df$HTGS)
  
  mStats <- data.frame(MeanShotsTaken , MeanShotsOnTarget, MeanCornerKicks, MeanFTGoals, MeanHTGoals)
  return(mStats)
}

#The function performanceCardsHomeAway computes average of cards received and fouls committed and against Home and Away teams
performanceCardsHomeAway <- function(x) {
  df <- x
  TotalGamesPlayed <- nrow(df)
  TotalFoulsCommitted <- sum(df$HF)
  TotalFoulsReceived <- sum(df$AF)
  TotalYellowCards <- sum(df$HY)
  TotalRedCards <- sum(df$HR)
  TotalOppYellowCards <- sum(df$AY)
  TotalOppRedCards <- sum(df$AR)
  MeanFoulsCommitted <- round(mean(df$HF), digits = 1)
  MeanFoulsReceived <- round(mean(df$AF), digits = 1)
  MeanYellowCards <- round(mean(df$HY), digits = 1)
  MeanRedCards <- round(mean(df$HR), digits = 1) 
  MeanOppYellowCards <- round(mean(df$AY), digits = 1) 
  MeanOppRedCards <- round(mean(df$AR), digits = 1)
  
  mStats <- data.frame(TotalGamesPlayed, TotalFoulsCommitted, TotalFoulsReceived, TotalYellowCards,    TotalRedCards, TotalOppYellowCards, TotalOppRedCards, MeanFoulsCommitted, MeanFoulsReceived, MeanYellowCards, MeanOppYellowCards, MeanRedCards, MeanOppRedCards)
  return(mStats)
}

#The function descriptiveStatsInfo takes a dataframe as input, and calculates the mean, median, min and max, standard deviation, quantiles (at 0.05 and 0.95), and skewness. 
descriptiveStatsInfo <- function(x) {
  #Computing statistical measurements for teams
  df <- x
  MeanFTWin <- mean(df$TotalFTWin)
  MeanFTLoss <- mean(df$TotalFTLoss)
  MeanFTDraw <- mean(df$TotalFTDraw)
  STDFTWin <- sd(df$TotalFTWin, na.rm=TRUE)
  STDFTLoss <- sd(df$TotalFTLoss, na.rm=TRUE)
  STDFTDraw <- sd(df$TotalFTDraw, na.rm=TRUE)
  MedianFTWin <- median(df$TotalFTWin)
  MedianFTLoss <- median(df$TotalFTLoss)
  MedianFTDraw <- median(df$TotalFTDraw)
  MinFTWin <- min(df$TotalFTWin)
  MaxFTWin <- max(df$TotalFTWin)
  MinFTLoss <- min(df$TotalFTLoss)
  MaxFTLoss <- max(df$TotalFTLoss)
  MinFTDraw <- min(df$TotalFTDraw)
  MaxFTDraw <- max(df$TotalFTDraw)
  
  QuantilesFTWinInfo <- quantile(df$TotalFTWin, probs = c(0.05, 0.95))
  SkewnessFTWinInfo <- skewness(df$TotalFTWin)
  QuantilesFTLossInfo <- quantile(df$TotalFTLoss, probs = c(0.05, 0.95))
  SkewnessFTLossInfo <- skewness(df$TotalFTLoss)
  QuantilesFTDrawInfo <- quantile(df$TotalFTDraw, probs = c(0.05, 0.95))
  SkewnessFTDrawInfo <- skewness(df$TotalFTDraw)
  
  mStats <- data.frame(MeanFTWin, MeanFTLoss, MeanFTDraw, STDFTWin, STDFTLoss, STDFTDraw, MedianFTWin, MedianFTLoss, MedianFTDraw, MinFTWin, MaxFTWin, MinFTLoss, MaxFTLoss, MinFTDraw, MaxFTDraw, QuantilesFTWinInfo, SkewnessFTWinInfo, QuantilesFTLossInfo, SkewnessFTLossInfo, QuantilesFTDrawInfo, SkewnessFTDrawInfo)
  
  return(mStats)
}

#The function summaryStatsHomeAway computes totals for Home and Away teams
summaryStatsHomeAway <- function(x, mTeam1, mHomeAway) {
  df <- x
  HomeAway <-mHomeAway 
  Team1 <-mTeam1
  TotalGamesPlayed <- nrow(df)
  TotalShotsTaken <- sum(df$ShotsTaken)
  TotalShotsOnTarget <- sum(df$ShotsOnTarget)
  TotalFoulsCommitted <- sum(df$FoulsCommitted)
  TotalCornerKicks <- sum(df$CornerKicks)
  TotalYellowCards <- sum(df$YellowCards)
  TotalRedCards <- sum(df$RedCards)
  TotalFTGoals <- sum(df$GS)
  TotalHTGoals <- sum(df$HTGS)
  df$FTR <- gsub(" ", "", df$FTR)
  df$HTR <- gsub(" ", "", df$HTR)
  TotalHTWin <- length(which(df$HTR=="H" ))
  TotalHTLoss <- length(which(df$HTR=="A" ))
  TotalHTDraw <- length(which(df$HTR=="D" ))
  TotalFTWin <- length(which(df$FTR=="H" ))
  TotalFTLoss <- length(which(df$FTR=="A" ))
  TotalFTDraw <- length(which(df$FTR=="D" ))
  
  mStats <- data.frame(Team1, HomeAway, TotalShotsTaken , TotalShotsOnTarget, TotalFoulsCommitted, TotalCornerKicks, TotalYellowCards, TotalRedCards, TotalFTGoals,TotalHTGoals,TotalHTWin, TotalHTLoss, TotalHTDraw, TotalFTWin, TotalFTLoss, TotalFTDraw, TotalGamesPlayed)
  
  return(mStats)
}

# The function performanceHomeAdvantage computes the Home Field Advantage
performanceHomeAdvantage <- function(x) {
  # Home field advantage will be calculated as follows:
  # The team gets 3 points for a win, 1 point for a draw, and zero for a loss.
  # Calculate the ratio of total points earned from all matches/games played at home vs. away.
  # If the ratio is 50%, it indicates that success has been achieved equally at home and away i.e.there is no home field advantage.
  # If the ratio is above 50% then it indicates that playing at home field increases the winning probability.
  
  df <- x
  mMax <- nrow(df)
  mCounter <- 1
  HomeAdvantagedf <- data.frame()
  while (mCounter <= (mMax-1)) {
    TotalHomePoints <- 0
    TotalAwayPoints <- 0
    if(df$HomeAway[mCounter] == "Home") {
      TotalHomePoints <- df$TotalFTWin[mCounter] * 3 + df$TotalFTDraw[mCounter] * 1 
      TotalAwayPoints <- df$TotalFTWin[mCounter+1] * 3 + df$TotalFTDraw[mCounter] * 1
    }
    HomeAdvantage = round(TotalHomePoints / (df$TotalGamesPlayed[mCounter] * 3) * 100, digits = 1)
    AwayAdvantage = round(TotalAwayPoints / (df$TotalGamesPlayed[mCounter] * 3) * 100, digits = 1)
    
    mStats       <- data.frame(df$Team1[mCounter], HomeAdvantage, AwayAdvantage, df$TotalGamesPlayed[mCounter])
    HomeAdvantagedf  <-  HomeAdvantagedf %>% rbind(mStats)
    
    mCounter <- mCounter + 2
    print(mCounter)
  }
  return(HomeAdvantagedf)
}


#Step 2: Create a dataframe with all teams (Home and Away) participating in the English Premier League and their totals.
premTeams <- gsub(" ", "", premTransformed$Team1)
premTeams <- unique(premTeams)
premStat <- premStat[order(premStat$Team1),]
premTeams

premHome <- premHomeTeams %>% mutate(HomeAway = "Home") %>% select(Date, Team1, Team2, HomeAway, GS, FTR, HTGS, HTR, ShotsTaken, ShotsOnTarget, FoulsCommitted, CornerKicks, YellowCards, RedCards)
premAway <- premAwayTeams %>% mutate(HomeAway = "Away") %>% select(Date, Team1, Team2, HomeAway, GS, FTR, HTGS, HTR, ShotsTaken, ShotsOnTarget, FoulsCommitted, CornerKicks, YellowCards, RedCards)

mCounter <- 1
mMax <-  length(premTeams)
premHomeTeamStat <- data.frame()
premAwayTeamStat <- data.frame()
premStat  <- data.frame()
while (mCounter <= mMax) {
  mTeam <- premTeams[mCounter]
  premHomeTeam <- premHome[ which(premHome$Team1 == mTeam),]
  premAwayTeam <- premAway[ which(premAway$Team1 == mTeam),]
  #premHomeTeamStat <- premHomeTeam[mCounter,2:4]  # to get the Team1, Team2, and HomeAway values
  #premAwayTeamStat <- premAwayTeam[mCounter,2:4]
  #premHomeTeamStat  <- premTeams[mCounter] 
  #premHomeTeamStat  <- premHomeTeamStat  
  #premAwayTeamStat  <- premTeams[mCounter]
  premHomeStatTemp  <- summaryStatsHomeAway(premHomeTeam, mTeam,"Home" )
  premAwayStatTemp  <- summaryStatsHomeAway(premAwayTeam, mTeam,"Away") 
  premHomeTeamStat  <- cbind(premHomeStatTemp)  
  premAwayTeamStat  <- cbind(premAwayStatTemp)
  premStat <- premStat  %>% rbind(premHomeTeamStat) 
  premStat <- premStat  %>% rbind(premAwayTeamStat)  
  mCounter <- mCounter + 1
}

#Reset index row numbers
rownames(premStat) <- NULL
#premStat <- premStat[,-2:-2]   # removing Team2

#Step 3: calculate the descriptive & performance statistics for all Home and Away teams.

#1. Calculate average goals scorded for or against for Home and Away teams
premHomeTeamGoals <- performanceGoalsHomeAway(premHome)
premAwayTeamGoals <- performanceGoalsHomeAway(premAway)  

#2. Calculate average cards received and fouls committed for Home and Away teams
premTeamCards  <- performanceCardsHomeAway(prem)

#3. Calculate descriptive statistics for Home and Away teams
premHomedescriptiveStats <- data.frame()
premAwaydescriptiveStats <- data.frame()
premHomedescriptiveStats <- descriptiveStatsInfo(premStat[which(premStat$HomeAway == "Home"),])
premAwaydescriptiveStats <- descriptiveStatsInfo(premStat[which(premStat$HomeAway == "Away"),])

#4. Calculate Home Advantage
premHomeAdvantage  <- data.frame()
premStat <- premStat[order(premStat$Team1,premStat$HomeAway),]
premHomeAdvantage  <- performanceHomeAdvantage(premStat)
premHomeAdvantage %>% arrange(desc(HomeAdvantage), desc(AwayAdvantage))

#Data modeling.



```